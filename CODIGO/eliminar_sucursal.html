<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Grupo Solvens - Carga de Puntos de Venta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <link rel="stylesheet" href="style/formulario.css">
    <link rel="stylesheet" href="style/modal.css">
</head>

<body>

    <header class="header">
        <div class="header-left">
            <a href="Admin_gestion_sucursal.html" class="btn-volver">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12" />
                    <polyline points="12 19 5 12 12 5" />
                </svg>
            </a>
        </div>
        <div class="header-center">
            <img src="../IMG/logo.png" alt="Logo Grupo Solvens" class="logo-nav">
        </div>
        <div class="header-right">
            <a href="login.html" class="btn-salir">Cerrar Sesión</a>
        </div>
    </header>

    <main class="contenido">
        <h1>Eliminar <span>Sucursal</span></h1>
        <p class="subtitulo">Filtre para encontrar la sucursal a eliminar</p>

        <div class="formulario">
            <div class="fila">
                <select id="select-cadena">
                    <option value="" disabled selected>1. Seleccione Cadena</option>
                </select>
            </div>

            <div class="fila">
                <select id="select-subzona" disabled>
                    <option value="" disabled selected>2. Seleccione Subzona</option>
                </select>
            </div>

            <div class="fila">
                <select id="select-sucursal" disabled>
                    <option value="" disabled selected>3. Seleccione la Sucursal</option>
                </select>
            </div>

            <button id="btn-eliminar" disabled>Eliminar Sucursal</button>
        </div>
    </main>

    <script src="js/modal_confirmacion.js"></script>
    <script>
        function mostrarToast(mensaje, tipo = 'exito') {
            const t = document.getElementById('toast');
            t.textContent = mensaje;
            t.className = 'toast ' + tipo;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3500);
        }

        const URL_BASE = '/api';
        const selCadena = document.getElementById('select-cadena');
        const selSubzona = document.getElementById('select-subzona');
        const selSucursal = document.getElementById('select-sucursal');
        const btnEliminar = document.getElementById('btn-eliminar');

        // Inicialización: Cargar Cadenas
        document.addEventListener("DOMContentLoaded", async () => {
            const res = await fetch(`${URL_BASE}/cadenas`);
            const data = await res.json();
            data.forEach(c => selCadena.innerHTML += `<option value="${c.ID}">${c.Nombre}</option>`);
        });

        // Evento 1: Al elegir Cadena, cargar Subzonas y habilitar
        selCadena.addEventListener('change', async () => {
            const res = await fetch(`${URL_BASE}/subzonas`);
            const data = await res.json();
            selSubzona.innerHTML = '<option value="" disabled selected>2. Seleccione Subzona</option>';
            data.forEach(s => selSubzona.innerHTML += `<option value="${s.ID}">${s.Nombre}</option>`);
            selSubzona.disabled = false;

            // Resetear siguientes pasos
            selSucursal.disabled = true;
            btnEliminar.disabled = true;
        });

        // Evento 2: Al elegir Subzona, buscar sucursales filtradas
        selSubzona.addEventListener('change', async () => {
            const res = await fetch(`${URL_BASE}/buscar-sucursales?id_cadena=${selCadena.value}&id_subzona=${selSubzona.value}`);
            const data = await res.json();

            selSucursal.innerHTML = '<option value="" disabled selected>3. Seleccione la Sucursal</option>';
            if (data.length === 0) {
                selSucursal.innerHTML = '<option value="" disabled>No hay sucursales en esta zona</option>';
            } else {
                data.forEach(s => {
                    // Combinamos Calle + Altura + Localidad como solicitaste
                    selSucursal.innerHTML += `<option value="${s.ID}">${s.Calle} ${s.Altura}, ${s.Localidad}</option>`;
                });
                selSucursal.disabled = false;
            }
            btnEliminar.disabled = true;
        });

        // Evento 3: Al elegir Sucursal, habilitar botón
        selSucursal.addEventListener('change', () => {
            btnEliminar.disabled = false;
        });

        // Acción de Eliminar
        btnEliminar.addEventListener('click', async () => {
            const confirmar = await mostrarConfirmacion({
                titulo: '¿Eliminar Sucursal?',
                mensaje: '¿Está seguro de que desea eliminar esta sucursal de forma permanente?',
            });

            if (!confirmar) return;

            const id = selSucursal.value;
            const res = await fetch(`${URL_BASE}/eliminar-sucursal/${id}`, { method: 'DELETE' });
            const result = await res.json();

            if (result.success) {
                mostrarToast(result.message, "exito");
                location.reload(); // Recargar para limpiar filtros
            } else {
                mostrarToast(result.message, "error");
            }
        });
    </script>


    <style>
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 14px 22px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            max-width: 360px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .toast.exito {
            background: #1a2e1a;
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .toast.error {
            background: #2e1a1a;
            border: 1px solid #dc2626;
            color: #f87171;
        }

        .toast.aviso {
            background: #2e2a1a;
            border: 1px solid #f59e0b;
            color: #fbbf24;
        }

        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <div class="toast" id="toast"></div>

</body>

</html>