<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <title>Login</title>
    <link rel="stylesheet" href="style/login.css">
</head>
<body>

<div class="borde">
    <div class="datos">
        <h2>Inicio de Sesión</h2>

        <!-- novalidate desactiva validación del navegador -->
        <form id="loginform" novalidate>

            <label for="user">Usuario</label>
            <input
                type="text"
                id="user"
                name="user"
                placeholder="Ingrese su usuario"
            />

            <label for="password">Contraseña</label>
            <input
                type="password"
                id="password"
                name="password"
                placeholder="Ingrese su contraseña"
            />

            <button type="submit">Ingresar</button>

            <p class="imagen">
                <img src="../IMG/logo.png" alt="Logo">
            </p>
        </form>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast hidden">
    <span class="toast-icon">✖</span>
    <span id="toast-msg"></span>
</div>

<script>
function mostrarToast(mensaje) {
    const toast = document.getElementById("toast");
    const msg = document.getElementById("toast-msg");

    msg.textContent = mensaje;
    toast.classList.remove("hidden");

    setTimeout(() => {
        toast.classList.add("hidden");
    }, 3500);
}

document.getElementById('loginform').addEventListener('submit', async (e) => {
    e.preventDefault();

    const userInput = document.getElementById('user');
    const passInput = document.getElementById('password');

    const user = userInput.value.trim();
    const password = passInput.value.trim();

    /* ===== VALIDACIÓN CUSTOM ===== */
    if (!user && !password) {
        mostrarToast("Completá usuario y contraseña");
        userInput.classList.add("input-error");
        passInput.classList.add("input-error");
        return;
    }

    if (!user) {
        mostrarToast("Ingresá tu usuario");
        userInput.classList.add("input-error");
        return;
    }

    if (!password) {
        mostrarToast("Ingresá tu contraseña");
        passInput.classList.add("input-error");
        return;
    }

    // limpiar estilos si está ok
    userInput.classList.remove("input-error");
    passInput.classList.remove("input-error");

    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user, password })
        });

        const data = await response.json();

        if (data.success) {
            localStorage.setItem('id_usuario', data.id); 
            localStorage.setItem('nombreUsuario', data.nombre);
            localStorage.setItem('tipoUsuario', data.tipo);
            
            const tipo = Number(data.tipo);
            if (tipo === 1) window.location.href = 'inicioAdmin.html';
            else if (tipo === 2) window.location.href = 'inicioCliente.html';
            else window.location.href = 'inicioRepositor.html';
        } else {
            mostrarToast(data.message || "Usuario o contraseña incorrectos");
        }

    } catch (error) {
        mostrarToast("No se pudo conectar con el servidor");
    }
});
</script>

</body>
</html>