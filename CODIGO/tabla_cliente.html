<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Reportes - Solvens</title>
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <link rel="stylesheet" href="../CODIGO/style/filtros.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<header class="header">
    <style>
        .btn-volver {
            display: flex;
            align-items: center;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
        }
        .btn-volver:hover {
            opacity: 1;
            transform: translateX(-3px);
        }
    </style>
    <a href="inicioCliente.html" class="btn-volver">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
        </svg>
    </a>
    <a href="login.html" class="btn-salir">Cerrar Sesión</a>
</header>

<button class="btn-toggle-sidebar" id="btnToggleSidebar">
    <i class="fas fa-filter"></i>
    <span>Filtros</span>
</button>

<div class="contenedor-layout">

    <aside class="sidebar-filtros" id="sidebarFiltros">
        <div class="sidebar-header">
            <h2 class="titulo-filtros">Filtros</h2>
            <button class="btn-cerrar-sidebar" id="btnCerrarSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Periodo -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Periodo</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione un rango de fechas:</p>
                <div class="rango-fechas">
                    <div>
                        <label class="label-pequeno">Desde:</label>
                        <input type="date" class="input-fecha" id="fechaDesde">
                    </div>
                    <div>
                        <label class="label-pequeno">Hasta:</label>
                        <input type="date" class="input-fecha" id="fechaHasta">
                    </div>
                </div>
            </div>
        </div>

        <!-- Cadenas -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Cadenas</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione la cadena:</p>
                <select class="select-filtro" id="filtroCadena">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>

        <!-- Bocas -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Bocas</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione la sucursal:</p>
                <select class="select-filtro" id="filtroSucursal">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>

        <!-- Canales -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Canales</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione el canal:</p>
                <select class="select-filtro" id="filtroCanal">
                    <option value="">Todos</option>
                </select>
            </div>
        </div>

        <!-- Región -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Región</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione la región:</p>
                <select class="select-filtro" id="filtroRegion">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>

        <!-- Categorías -->
        <div class="grupo-filtro">
            <div class="filtro-header">
                <label class="label-filtro">Categorías</label>
                <i class="fas fa-chevron-down icono-toggle"></i>
            </div>
            <div class="filtro-contenido">
                <p class="descripcion-filtro">Seleccione la categoría:</p>
                <select class="select-filtro" id="filtroCategoria">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>

        <div class="botones-filtro">
            <button class="btn-aplicar-filtros" id="btnAplicar">Aplicar Filtros</button>
            <button class="btn-limpiar-filtros" id="btnLimpiar">Limpiar Filtros</button>
        </div>
    </aside>

    <main class="area-contenido">
        <h1 class="page-titulo">Listado de mis <span>Productos</span></h1>
        <p class="page-subtitulo" id="subtitulo">Cargando...</p>

        <div class="barra-resultados">
            <span>Mostrando <strong id="conteoResultados">0</strong> registros</span>
            <div style="display:flex;gap:10px;align-items:center;">
                <button id="btnExportar" style="background-color: #107c10; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold;">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
                <div id="tagsActivos" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
            </div>
        </div>

        <div class="tabla-wrapper">
            <table class="tabla-reporte">
                <thead>
                    <tr>
                        <th data-col="Fecha">Fecha <span class="sort-icon">↕</span></th>
                        <th data-col="Cadena">Cadena <span class="sort-icon">↕</span></th>
                        <th data-col="Comercio">Comercio <span class="sort-icon">↕</span></th>
                        <th data-col="Localidad">Localidad <span class="sort-icon">↕</span></th>
                        <th data-col="Region">Región <span class="sort-icon">↕</span></th>
                        <th data-col="Cluster">Cluster <span class="sort-icon">↕</span></th>
                        <th data-col="Canal">Canal <span class="sort-icon">↕</span></th>
                        <th data-col="Usuario">Repositor <span class="sort-icon">↕</span></th>
                        <th data-col="Categoria">Categoría <span class="sort-icon">↕</span></th>
                        <th data-col="Producto">Producto <span class="sort-icon">↕</span></th>
                        <th data-col="SKU">SKU <span class="sort-icon">↕</span></th>
                        <th data-col="Precio">Precio <span class="sort-icon">↕</span></th>
                        <th data-col="Oferta">Oferta <span class="sort-icon">↕</span></th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla">
                    <tr><td colspan="13">
                        <div class="estado-tabla">
                            <div class="spinner"></div>
                            <p>Cargando datos...</p>
                        </div>
                    </td></tr>
                </tbody>
            </table>
        </div>

        <div class="paginacion" id="paginacion"></div>
    </main>
</div>

<script>
const API_BASE     = 'http://localhost:3000/api';
const FILAS_PAGINA = 50;
const id = localStorage.getItem('id_usuario'); 

let datosCompletos = [];
let paginaActual   = 1;
let sortCol        = null;
let sortDir        = 'asc';

// ID del cliente desde la sesión
const idCliente = localStorage.getItem('id_usuario');

const cuerpo       = document.getElementById('cuerpoTabla');
const conteoEl     = document.getElementById('conteoResultados');
const tagsEl       = document.getElementById('tagsActivos');
const paginacionEl = document.getElementById('paginacion');

// ── Sidebar ──
document.getElementById('btnToggleSidebar').addEventListener('click', () => {
    document.getElementById('sidebarFiltros').classList.add('activo');
    document.getElementById('btnToggleSidebar').classList.add('oculto');
});
document.getElementById('btnCerrarSidebar').addEventListener('click', () => {
    document.getElementById('sidebarFiltros').classList.remove('activo');
    document.getElementById('btnToggleSidebar').classList.remove('oculto');
});

// ── Colapsar/expandir grupos ──
document.querySelectorAll('.filtro-header').forEach(header => {
    header.addEventListener('click', () => {
        const grupo     = header.parentElement;
        const contenido = header.nextElementSibling;
        const icono     = header.querySelector('.icono-toggle');
        grupo.classList.toggle('colapsado');
        if (grupo.classList.contains('colapsado')) {
            contenido.style.maxHeight = '0';
            icono.style.transform = 'rotate(-90deg)';
        } else {
            contenido.style.maxHeight = contenido.scrollHeight + 'px';
            icono.style.transform = 'rotate(0deg)';
        }
    });
});

// comprovacionidcliente
document.addEventListener('DOMContentLoaded', () => {
    if (!idCliente) {
        // no se encontro el id
        document.getElementById('subtitulo').textContent = '';
        cargarOpciones();
        return;
    }

    // Subtítulo con nombre del cliente
    const nombre = localStorage.getItem('nombre_usuario');
    document.getElementById('subtitulo').textContent =
        nombre ? `Visitas registradas para ${nombre}.` : 'Visitas registradas para tu cuenta.';

    // Colapsar todos al inicio
    document.querySelectorAll('.grupo-filtro').forEach(g => {
        g.classList.add('colapsado');
        g.querySelector('.filtro-contenido').style.maxHeight = '0';
        g.querySelector('.icono-toggle').style.transform = 'rotate(-90deg)';
    });

    cargarOpciones();
    cargarDatos();
});

// select default todo
async function cargarOpciones() {
    try {
        const res  = await fetch(`${API_BASE}/filtros-opciones`);
        const data = await res.json();
        poblarSelect('filtroCadena',    data.cadenas);
        poblarSelect('filtroSucursal',  data.sucursales);
        poblarSelect('filtroCanal',     data.canales);
        poblarSelect('filtroRegion',    data.regiones);
        poblarSelect('filtroCategoria', data.categorias);
    } catch (e) { console.error('Error cargando opciones de filtros:', e); }
}

function poblarSelect(id, lista) {
    const sel = document.getElementById(id);
    lista.forEach(item => {
        const opt = document.createElement('option');
        opt.value       = item.ID;
        opt.textContent = item.Nombre;
        sel.appendChild(opt);
    });
}


function buildParams() {
    const p = new URLSearchParams();
    p.set('id_cliente', idCliente);
    const v = (id) => document.getElementById(id).value;
    if (v('fechaDesde'))      p.set('fecha_desde',  v('fechaDesde'));
    if (v('fechaHasta'))      p.set('fecha_hasta',  v('fechaHasta'));
    if (v('filtroCadena'))    p.set('id_cadena',     v('filtroCadena'));
    if (v('filtroSucursal'))  p.set('id_sucursal',   v('filtroSucursal'));
    if (v('filtroCanal'))     p.set('id_canal',      v('filtroCanal'));
    if (v('filtroRegion'))    p.set('id_region',     v('filtroRegion'));
    if (v('filtroCategoria')) p.set('id_categoria',  v('filtroCategoria'));
    return p;
}

// Cargar datos
async function cargarDatos() {
    mostrarCargando();
    try {
        const params = buildParams();
        const res    = await fetch(`${API_BASE}/reporte-visitas-cliente?${params}`);
        datosCompletos = await res.json();
        paginaActual   = 1;
        actualizarTags(params);
        renderTabla();
    } catch (e) { mostrarError(); }
}

// ── Render tabla ──
function renderTabla() {
    let datos = [...datosCompletos];

    if (sortCol) {
        datos.sort((a, b) => {
            const av = a[sortCol], bv = b[sortCol];
            if (av == null) return 1;
            if (bv == null) return -1;
            const cmp = String(av).localeCompare(String(bv), 'es', { numeric: true });
            return sortDir === 'asc' ? cmp : -cmp;
        });
    }

    const total  = datos.length;
    const inicio = (paginaActual - 1) * FILAS_PAGINA;
    const pagina = datos.slice(inicio, inicio + FILAS_PAGINA);

    conteoEl.textContent = total;

    if (total === 0) {
        cuerpo.innerHTML = `<tr><td colspan="13"><div class="estado-tabla">
            <i class="fas fa-search"></i>
            <p>No se encontraron registros con los filtros aplicados.</p>
        </div></td></tr>`;
        paginacionEl.innerHTML = '';
        return;
    }

    cuerpo.innerHTML = pagina.map(r => `
        <tr>
            <td class="col-fecha">${formatFecha(r.Fecha)}</td>
            <td>${r.Cadena    || '-'}</td>
            <td>${r.Comercio  || '-'}</td>
            <td>${r.Localidad || '-'}</td>
            <td>${r.Region    || '-'}</td>
            <td>${r.Cluster   || '-'}</td>
            <td>${r.Canal     || '-'}</td>
            <td>${r.Usuario   || '-'}</td>
            <td>${r.Categoria || '-'}</td>
            <td>${r.Producto  || '-'}</td>
            <td>${r.SKU       || '-'}</td>
            <td class="col-precio">$${Number(r.Precio).toFixed(2)}</td>
            <td><span class="badge-oferta ${r.Oferta === 'Sí' ? 'si' : 'no'}">${r.Oferta}</span></td>
        </tr>`).join('');

    renderPaginacion(total);
}

// ── Paginación ──
function renderPaginacion(total) {
    const totalPags = Math.ceil(total / FILAS_PAGINA);
    if (totalPags <= 1) { paginacionEl.innerHTML = ''; return; }
    let html = `<button ${paginaActual===1?'disabled':''} onclick="irPagina(${paginaActual-1})">‹</button>`;
    for (let i = 1; i <= totalPags; i++) {
        if (i===1 || i===totalPags || Math.abs(i-paginaActual)<=2)
            html += `<button class="${i===paginaActual?'activa':''}" onclick="irPagina(${i})">${i}</button>`;
        else if (Math.abs(i-paginaActual)===3)
            html += `<button disabled>…</button>`;
    }
    html += `<button ${paginaActual===totalPags?'disabled':''} onclick="irPagina(${paginaActual+1})">›</button>`;
    paginacionEl.innerHTML = html;
}
window.irPagina = (p) => { paginaActual = p; renderTabla(); window.scrollTo(0,0); };

// ── Ordenar columnas ──
document.querySelectorAll('thead th[data-col]').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        sortDir = sortCol === col && sortDir === 'asc' ? 'desc' : 'asc';
        sortCol = col;
        document.querySelectorAll('thead th').forEach(t => { t.classList.remove('sort-asc','sort-desc'); t.querySelector('.sort-icon').textContent = '↕'; });
        th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.querySelector('.sort-icon').textContent = sortDir === 'asc' ? '↑' : '↓';
        renderTabla();
    });
});

// ── Tags filtros activos (no muestra id_cliente) ──
const LABEL_FILTRO = { fecha_desde:'Desde', fecha_hasta:'Hasta', id_cadena:'Cadena', id_sucursal:'Boca', id_canal:'Canal', id_region:'Región', id_categoria:'Categoría' };
function actualizarTags(params) {
    tagsEl.innerHTML = '';
    params.forEach((val, key) => {
        if (key === 'id_cliente') return;
        const tag = document.createElement('span');
        tag.className = 'tag-filtro-activo';
        tag.innerHTML = `<i class="fas fa-tag"></i> ${LABEL_FILTRO[key] || key}`;
        tagsEl.appendChild(tag);
    });
}

// ── Botones ──
document.getElementById('btnAplicar').addEventListener('click', cargarDatos);
document.getElementById('btnLimpiar').addEventListener('click', () => {
    ['fechaDesde','fechaHasta','filtroCadena','filtroSucursal','filtroCanal','filtroRegion','filtroCategoria']
        .forEach(id => document.getElementById(id).value = '');
    cargarDatos();
});
// botón de exportar
const exportBtn = document.getElementById('btnExportar');
if (exportBtn) exportBtn.addEventListener('click', exportTabla);

// ── Helpers ──
function formatFecha(f) {
    if (!f) return '-';
    return new Date(f).toLocaleDateString('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' });
}

// exportar datos a CSV/Excel
function exportTabla() {
    if (!datosCompletos || datosCompletos.length === 0) return;
    const cols = [
        'Fecha','Cadena','Comercio','Localidad','Región','Cluster','Canal',
        'Repositor','Categoría','Producto','SKU','Precio','Oferta'
    ];
    const rows = datosCompletos.map(r => [
        formatFecha(r.Fecha), r.Cadena||'', r.Comercio||'', r.Localidad||'',
        r.Region||'', r.Cluster||'', r.Canal||'', r.Usuario||'',
        r.Categoria||'', r.Producto||'', r.SKU||'',
        r.Precio!=null ? Number(r.Precio).toFixed(2) : '',
        r.Oferta||''
    ]);
    // construir CSV
    const esc = v => `"${String(v).replace(/"/g,'""')}"`;
    let csv = cols.join(',') + '\r\n';
    rows.forEach(r => {
        csv += r.map(esc).join(',') + '\r\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'mis_reportes.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function mostrarCargando() {
    cuerpo.innerHTML = `<tr><td colspan="13"><div class="estado-tabla"><div class="spinner"></div><p>Cargando datos...</p></div></td></tr>`;
}
function mostrarError() {
    cuerpo.innerHTML = `<tr><td colspan="13"><div class="estado-tabla"><i class="fas fa-exclamation-circle"></i><p>Error al conectar con el servidor.</p></div></td></tr>`;
}
</script>
</body>
</html>
