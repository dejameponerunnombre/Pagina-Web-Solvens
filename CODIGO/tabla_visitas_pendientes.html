<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitas Pendientes - Solvens</title>
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <link rel="stylesheet" href="../CODIGO/style/filtros.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../CODIGO/style/tablas_pendientes.css">
</head>
<body>

<header class="header">
    <a href="inicioAdmin.html" class="btn-volver">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
        </svg>
    </a>
    <a href="login.html" class="btn-salir">Cerrar Sesión</a>
</header>

<div class="contenedor-layout">
    <main class="area-contenido">
        <h1 class="page-titulo">Visitas <span>Pendientes</span></h1>
        <p class="page-subtitulo">Visitas cargadas por repositores que aguardan aprobación.</p>

        <div class="barra-resultados">
            <span>Mostrando <strong id="conteoResultados">0</strong> visitas pendientes</span>
        </div>

        <div class="tabla-wrapper">
            <table class="tabla-reporte">
                <thead>
                    <tr>
                        <th data-col="Fecha">Fecha <span class="sort-icon">↕</span></th>
                        <th data-col="Repositor">Repositor <span class="sort-icon">↕</span></th>
                        <th data-col="Sucursal">Sucursal <span class="sort-icon">↕</span></th>
                        <th data-col="Cliente">Cliente <span class="sort-icon">↕</span></th>
                        <th class="col-accion">Acción</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla">
                    <tr><td colspan="5">
                        <div class="estado-tabla">
                            <div class="spinner"></div>
                            <p>Cargando datos...</p>
                        </div>
                    </td></tr>
                </tbody>
            </table>
        </div>

        <div class="paginacion" id="paginacion"></div>
    </main>
</div>

<div id="toast"></div>

<script>
const API_BASE     = 'http://localhost:3000/api';
const FILAS_PAGINA = 50;

let datosCompletos = [];
let paginaActual   = 1;
let sortCol        = null;
let sortDir        = 'asc';

const cuerpo       = document.getElementById('cuerpoTabla');
const conteoEl     = document.getElementById('conteoResultados');
const paginacionEl = document.getElementById('paginacion');

document.addEventListener('DOMContentLoaded', cargarDatos);

async function cargarDatos() {
    mostrarCargando();
    try {
        const res      = await fetch(`${API_BASE}/visitas-pendientes`);
        datosCompletos = await res.json();
        paginaActual   = 1;
        renderTabla();
    } catch (e) { mostrarError(); }
}

function renderTabla() {
    let datos = [...datosCompletos];

    if (sortCol) {
        datos.sort((a, b) => {
            const av = a[sortCol], bv = b[sortCol];
            if (av == null) return 1;
            if (bv == null) return -1;
            const cmp = String(av).localeCompare(String(bv), 'es', { numeric: true });
            return sortDir === 'asc' ? cmp : -cmp;
        });
    }

    const total  = datos.length;
    const inicio = (paginaActual - 1) * FILAS_PAGINA;
    const pagina = datos.slice(inicio, inicio + FILAS_PAGINA);

    conteoEl.textContent = total;

    if (total === 0) {
        cuerpo.innerHTML = `<tr><td colspan="5"><div class="estado-tabla">
            <i class="fas fa-check-circle" style="color:#4ade80;opacity:0.5;"></i>
            <p>No hay visitas pendientes de aprobación.</p>
        </div></td></tr>`;
        paginacionEl.innerHTML = '';
        return;
    }

    cuerpo.innerHTML = pagina.map(r => `
        <tr id="fila-${r.ID_Visita}">
            <td class="col-fecha">${formatFecha(r.Fecha)}</td>
            <td>${r.Repositor || '-'}</td>
            <td>${r.Sucursal  || '-'}</td>
            <td>${r.Cliente   || '-'}</td>
            <td class="col-accion">
                <button class="btn-aprobar" id="btn-${r.ID_Visita}" onclick="aprobarVisita(${r.ID_Visita})">
                    <i class="fas fa-check"></i> Aprobar
                </button>
            </td>
        </tr>`).join('');

    renderPaginacion(total);
}

async function aprobarVisita(id) {
    const btn = document.getElementById(`btn-${id}`);
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Aprobando...`;

    try {
        const res  = await fetch(`${API_BASE}/aprobar-visita/${id}`, { method: 'PATCH' });
        const data = await res.json();

        if (res.ok && data.success) {
            btn.classList.add('aprobado');
            btn.innerHTML = `<i class="fas fa-check-double"></i> Aprobada`;
            mostrarToast(`Visita #${id} aprobada correctamente.`, 'exito');
            setTimeout(() => {
                const fila = document.getElementById(`fila-${id}`);
                if (fila) {
                    fila.style.transition = 'opacity 0.4s, transform 0.4s';
                    fila.style.opacity    = '0';
                    fila.style.transform  = 'translateX(30px)';
                    setTimeout(() => {
                        datosCompletos = datosCompletos.filter(v => v.ID_Visita !== id);
                        renderTabla();
                    }, 400);
                }
            }, 800);
        } else {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-check"></i> Aprobar`;
            mostrarToast(data.message || 'Error al aprobar.', 'error');
        }
    } catch (e) {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-check"></i> Aprobar`;
        mostrarToast('No se pudo conectar con el servidor.', 'error');
    }
}
window.aprobarVisita = aprobarVisita;

function renderPaginacion(total) {
    const totalPags = Math.ceil(total / FILAS_PAGINA);
    if (totalPags <= 1) { paginacionEl.innerHTML = ''; return; }
    let html = `<button ${paginaActual===1?'disabled':''} onclick="irPagina(${paginaActual-1})">‹</button>`;
    for (let i = 1; i <= totalPags; i++) {
        if (i===1 || i===totalPags || Math.abs(i-paginaActual)<=2)
            html += `<button class="${i===paginaActual?'activa':''}" onclick="irPagina(${i})">${i}</button>`;
        else if (Math.abs(i-paginaActual)===3)
            html += `<button disabled>…</button>`;
    }
    html += `<button ${paginaActual===totalPags?'disabled':''} onclick="irPagina(${paginaActual+1})">›</button>`;
    paginacionEl.innerHTML = html;
}
window.irPagina = (p) => { paginaActual = p; renderTabla(); window.scrollTo(0,0); };

document.querySelectorAll('thead th[data-col]').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        sortDir = sortCol === col && sortDir === 'asc' ? 'desc' : 'asc';
        sortCol = col;
        document.querySelectorAll('thead th').forEach(t => {
            t.classList.remove('sort-asc','sort-desc');
            const si = t.querySelector('.sort-icon');
            if (si) si.textContent = '↕';
        });
        th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.querySelector('.sort-icon').textContent = sortDir === 'asc' ? '↑' : '↓';
        renderTabla();
    });
});

let toastTimer;
function mostrarToast(msg, tipo) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className   = `show ${tipo}`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { t.className = ''; }, 3500);
}

function formatFecha(f) {
    if (!f) return '-';
    return new Date(f).toLocaleDateString('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' });
}
function mostrarCargando() {
    cuerpo.innerHTML = `<tr><td colspan="5"><div class="estado-tabla"><div class="spinner"></div><p>Cargando datos...</p></div></td></tr>`;
}
function mostrarError() {
    cuerpo.innerHTML = `<tr><td colspan="5"><div class="estado-tabla"><i class="fas fa-exclamation-circle"></i><p>Error al conectar con el servidor.</p></div></td></tr>`;
}
</script>
</body>
</html>
