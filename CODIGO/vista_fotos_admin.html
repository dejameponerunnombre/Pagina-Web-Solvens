<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Evidencia de Visita</title>
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style/filtros.css">
    <link rel="stylesheet" href="style/vista_fotos.css">
    <link rel="stylesheet" href="style/inicio.css">
    <style>
        /* Estilos de botones de acción */
        .btn-accion {
            margin: 4px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            font-size: 12px;
        }

        .btn-accion.aprobar { background-color: #22c55e; }
        .btn-accion.rechazar { background-color: #ef4444; }

        .img-actions {
            position: absolute;
            bottom: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
            z-index: 10;
        }

        /* Lógica de Rotación */
        .btn-rotar {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-rotar:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .img {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #000;
            border-radius: 8px;
        }

        .img img {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 100%;
            display: block;
        }

        /* Navegación de visitas */
        .visita-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }

        .nav-btn:hover { background: #dc2626; }

        /* Lightbox Meta & Acciones */
        .lightbox-meta {
            position: relative;
            margin: 0 0 15px 0;
            background: rgba(18, 18, 18, 0.9);
            padding: 10px 24px;
            border-radius: 30px;
            color: #fff;
            display: flex;
            gap: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(220, 38, 38, 0.3);
            z-index: 1000;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .status-aprobado { background: #22c55e; }
        .status-rechazado { background: #ef4444; }
        .status-pendiente { background: #eab308; }

        .lightbox-accion {
            position: absolute;
            bottom: 30px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        .lightbox-accion.aprobar { background: #22c55e; left: calc(50% - 115px); }
        .lightbox-accion.rechazar { background: #ef4444; left: calc(50% + 5px); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 14px 22px;
            border-radius: 8px;
            color: #fff;
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
        }

        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.exito { background: #1a2e1a; border: 1px solid #4ade80; color: #4ade80; }
        .toast.error { background: #2e1a1a; border: 1px solid #dc2626; color: #f87171; }
    </style>
</head>

<body>

    <header class="header">
        <div class="header-left">
            <a href="Admin_gestion_visitas.html" class="btn-volver">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12" />
                    <polyline points="12 19 5 12 12 5" />
                </svg>
            </a>
            <button class="btn-toggle-sidebar" id="btnToggleSidebar">
                <i class="fas fa-filter"></i>
                <span>Filtros</span>
            </button>
        </div>
        <div class="header-center">
            <img src="../IMG/logo.png" alt="Logo" class="logo-nav">
        </div>
        <div class="header-right">
            <a href="login.html" class="btn-salir">Cerrar Sesión</a>
        </div>
    </header>

    <main class="contenido">
        <h1>Evidencia <span>Fotográfica</span></h1>
        <p class="page-subtitulo">Panel de auditoría de imágenes</p>

        <div class="contenedor-layout">
            <aside class="sidebar-filtros" id="sidebarFiltros">
                <div class="sidebar-header">
                    <h2 class="titulo-filtros">Filtros</h2>
                    <button class="btn-cerrar-sidebar" id="btnCerrarSidebar"><i class="fas fa-times"></i></button>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header"><label class="label-filtro">Periodo</label></div>
                    <div class="filtro-contenido">
                        <input type="date" class="input-fecha" id="fechaDesde">
                        <input type="date" class="input-fecha" id="fechaHasta">
                    </div>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header"><label class="label-filtro">Cliente</label></div>
                    <select class="select-filtro" id="filtroCliente"><option value="">Todos</option></select>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header"><label class="label-filtro">Cadena</label></div>
                    <select class="select-filtro" id="filtroCadena"><option value="">Todas</option></select>
                </div>
                <div class="botones-filtro">
                    <button id="btnAplicarFiltros" class="btn-aplicar-filtros">Aplicar</button>
                    <button id="btnLimpiarFiltros" class="btn-limpiar-filtros">Limpiar</button>
                </div>
            </aside>

            <div class="visita-nav">
                <button id="prevVisita" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                <div id="contenedorVisitas" style="width: 100%;"></div>
                <button id="nextVisita" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </main>

    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close"><i class="fas fa-times"></i></button>
        <button class="lightbox-prev" id="lightbox-prev"><i class="fas fa-chevron-left"></i></button>
        <img class="lightbox-img" id="lightbox-img" src="">
        <button class="lightbox-next" id="lightbox-next"><i class="fas fa-chevron-right"></i></button>
        <div id="lightbox-meta" class="lightbox-meta"></div>
        <button class="lightbox-accion aprobar" id="lightbox-aprobar">✓ Aprobar</button>
        <button class="lightbox-accion rechazar" id="lightbox-rechazar">✕ Rechazar</button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let visitasData = [];
        let filteredVisitas = [];
        let visitaIndex = 0;
        let imgs = [];
        let current = 0;
        let currentLightboxImgId = null;

        async function cargarVisitasAdmin() {
            const res = await fetch('/api/imagenes-visitas');
            visitasData = res.ok ? await res.json() : [];
            populateFilters();
            applyFilters();
        }

        function renderVisita(idx) {
            const v = filteredVisitas[idx];
            const cont = document.getElementById('contenedorVisitas');
            if (!v) return;

            const imgsHtml = v.imagenes.map((img, i) => {
                const est = img.estado || 'Pendiente';
                return `
                    <li>
                        <div${i === 0 ? ' class="scroll-start"' : ''}>
                            <div class="img">
                                <span class="status-pill status-${estClass}">${est}</span>
                                <button class="btn-rotar" title="Rotar imagen" onclick="rotarImagen(this, event)">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <img src="../IMG/${img.ruta}" alt="Foto ${i + 1}" data-id="${img.id}" data-rotation="0">
                                <div class="img-actions">
                                    <button class="btn-accion aprobar" onclick="actualizarEstadoImagen(${img.id}, 'Aprobado')">✓</button>
                                    <button class="btn-accion rechazar" onclick="actualizarEstadoImagen(${img.id}, 'Rechazado')">✕</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>`;
            }).join('');

            cont.innerHTML = `
            <div class="visita-bloque">
                <ul class="carousel">${imgsHtml}</ul>
                <div class="visita-meta">
                    <span><i class="fas fa-building"></i> <strong>${v.cadena}</strong></span>
                    <span><i class="fas fa-map-marker-alt"></i> ${v.sucursal}</span>
                    <span><i class="fas fa-user"></i> ${v.repositor}</span>
                    <span><i class="fas fa-calendar-alt"></i> ${new Date(v.fecha).toLocaleDateString()}</span>
                </div>
            </div>`;
            wireImages();
        }

        // --- LÓGICA DE ROTACIÓN ---
        function rotarImagen(boton, event) {
            event.stopPropagation(); // Evita abrir el Lightbox
            const img = boton.parentElement.querySelector('img');
            let rotation = parseInt(img.getAttribute('data-rotation') || 0);
            rotation = (rotation + 90) % 360;
            
            // Si la foto está de lado (90 o 270), se achica un poco para que no se corte
            const scale = (rotation === 90 || rotation === 270) ? 0.7 : 1;
            img.style.transform = `rotate(${rotation}deg) scale(${scale})`;
            img.setAttribute('data-rotation', rotation);
        }

        async function actualizarEstadoImagen(idImg, nuevoEstado) {
            const res = await fetch(`/api/imagen/${idImg}/estado`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado })
            });
            if (res.ok) {
                mostrarToast(`Imagen ${nuevoEstado}`);
                await cargarVisitasAdmin();
                if (document.getElementById('lightbox').classList.contains('activo')) updateLightboxInfo();
            }
        }

        // lightbox helpers copied from cliente view
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        let current = 0;
        let currentLightboxImgId = null;

        // --- LÓGICA DE ROTACIÓN ---
        function rotarImagen(boton, event) {
            event.stopPropagation(); // Evita abrir el Lightbox
            const img = boton.parentElement.querySelector('img');
            let rotation = parseInt(img.getAttribute('data-rotation') || 0);
            rotation = (rotation + 90) % 360;

            // Si la foto está de lado (90 o 270), se achica un poco para que no se corte
            const scale = (rotation === 90 || rotation === 270) ? 0.7 : 1;
            img.style.transform = `rotate(${rotation}deg) scale(${scale})`;
            img.setAttribute('data-rotation', rotation);
        }

        function openLightbox(index) {
            current = index;
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightbox-img');
            lbImg.src = imgs[current].src;
            currentLightboxImgId = imgs[current].dataset.id || null;

            // Apply current rotation to lightbox
            const currentRotation = imgs[current].getAttribute('data-rotation') || 0;
            const scale = (currentRotation == 90 || currentRotation == 270) ? 0.7 : 1;
            lbImg.style.transform = `rotate(${currentRotation}deg) scale(${scale})`;

            updateLightboxInfo();
            lb.classList.add('activo');
        }

        function updateLightboxInfo() {
            const v = filteredVisitas[visitaIndex];
            const metaEl = document.getElementById('lightbox-meta');
            const imgData = v.imagenes.find(img => img.id == currentLightboxImgId);
            const estado = imgData ? imgData.estado : 'Pendiente';

            metaEl.innerHTML = `
                <span><i class="fas fa-building"></i> ${v.cadena}</span>
                <span><i class="fas fa-user"></i> ${v.repositor}</span>
                <span class="status-badge status-${estado.toLowerCase()}">${estado}</span>
            `;
        }

        function mostrarToast(mensaje) {
            const t = document.getElementById('toast');
            t.textContent = mensaje;
            t.className = 'toast exito visible';
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
        document.getElementById('lightbox-prev').addEventListener('click', () => {
            if (current > 0) {
                current--;
                lbImg.src = imgs[current].src;
                currentLightboxImgId = imgs[current].dataset.id || null;
                const currentRotation = imgs[current].getAttribute('data-rotation') || 0;
                const scale = (currentRotation == 90 || currentRotation == 270) ? 0.7 : 1;
                lbImg.style.transform = `rotate(${currentRotation}deg) scale(${scale})`;
                updateLightboxInfo();
            } else {
                // Si es la primera foto, saltamos a la última de la visita anterior
                visitaIndex = (visitaIndex - 1 + filteredVisitas.length) % filteredVisitas.length;
                renderVisita(visitaIndex);
                openLightbox(imgs.length - 1);
            }
        });

        document.getElementById('lightbox-next').addEventListener('click', () => {
            if (current < imgs.length - 1) {
                current++;
                lbImg.src = imgs[current].src;
                currentLightboxImgId = imgs[current].dataset.id || null;
                const currentRotation = imgs[current].getAttribute('data-rotation') || 0;
                const scale = (currentRotation == 90 || currentRotation == 270) ? 0.7 : 1;
                lbImg.style.transform = `rotate(${currentRotation}deg) scale(${scale})`;
                updateLightboxInfo();
            } else {
                // Si es la última foto, saltamos a la primera de la siguiente visita
                visitaIndex = (visitaIndex + 1) % filteredVisitas.length;
                renderVisita(visitaIndex);
                openLightbox(0);
            }
        });
        document.getElementById('lightbox-aprobar').addEventListener('click', () => {
            if (currentLightboxImgId) actualizarEstadoImagen(currentLightboxImgId, 'Aprobado');
        });
        document.getElementById('lightbox-rechazar').addEventListener('click', () => {
            if (currentLightboxImgId) actualizarEstadoImagen(currentLightboxImgId, 'Rechazado');
        });
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('activo')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') document.getElementById('lightbox-prev').click();
            if (e.key === 'ArrowRight') document.getElementById('lightbox-next').click();
        });

        document.getElementById('prevVisita').addEventListener('click', () => {
            visitaIndex = (visitaIndex - 1 + filteredVisitas.length) % filteredVisitas.length;
            renderVisita(visitaIndex);
        });
        document.getElementById('nextVisita').addEventListener('click', () => {
            visitaIndex = (visitaIndex + 1) % filteredVisitas.length;
            renderVisita(visitaIndex);
        });

        // filtro helpers
        function populateFilters() {
            const selC = document.getElementById('filtroCliente');
            const clientes = [...new Set(visitasData.map(v => v.cliente))];
            clientes.forEach(c => selC.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function applyFilters() {
            const fC = document.getElementById('filtroCliente').value;
            filteredVisitas = fC ? visitasData.filter(v => v.cliente === fC) : visitasData;
            visitaIndex = 0;
            renderVisita(visitaIndex);
        }

        document.getElementById('lightbox-close').onclick = () => document.getElementById('lightbox').classList.remove('activo');
        document.getElementById('nextVisita').onclick = () => { visitaIndex = (visitaIndex + 1) % filteredVisitas.length; renderVisita(visitaIndex); };
        document.getElementById('prevVisita').onclick = () => { visitaIndex = (visitaIndex - 1 + filteredVisitas.length) % filteredVisitas.length; renderVisita(visitaIndex); };
        
        document.addEventListener('DOMContentLoaded', cargarVisitasAdmin);
    </script>
</body>
</html>