<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo Solvens - Evidencia de Visita</title>
    <link rel="icon" href="../IMG/logo2.jpg" type="image/jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style/filtros.css">
    <link rel="stylesheet" href="style/vista_fotos.css">
    <!-- use same footer styling as inicioCliente -->
    <link rel="stylesheet" href="style/inicio.css">
    <style>
        /* navigation between visits (copied from admin page) */
        .visita-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .lightbox-close {
            z-index: 10001 !important;
        }

        /* Lightbox Meta (Horizontal Pill) */
        .lightbox-meta {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            padding: 8px 20px;
            border-radius: 40px;
            color: #fff;
            text-align: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .lightbox-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #eee;
        }

        .lightbox-meta span i {
            color: #dc2626;
            font-size: 11px;
        }
    </style>
</head>

<body>

    <header class="header">
        <div class="header-left">
            <a href="inicioCliente.html" class="btn-volver">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12" />
                    <polyline points="12 19 5 12 12 5" />
                </svg>
            </a>
            <button class="btn-toggle-sidebar" id="btnToggleSidebar">
                <i class="fas fa-filter"></i>
                <span>Filtros</span>
            </button>
        </div>
        <div class="header-center">
            <img src="../IMG/logo.png" alt="Logo Grupo Solvens" class="logo-nav">
        </div>
        <div class="header-right">
            <a href="login.html" class="btn-salir">Cerrar Sesi칩n</a>
        </div>
    </header>
    <main class="contenido">
        <h1>Evidencia <span>Fotogr치fica</span></h1>
        <p class="page-subtitulo">Registro visual de visitas aprobadas</p>
        <div class="contenedor-layout">
            <aside class="sidebar-filtros" id="sidebarFiltros">
                <div class="sidebar-header">
                    <h2 class="titulo-filtros">Filtros</h2>
                    <button class="btn-cerrar-sidebar" id="btnCerrarSidebar"><i class="fas fa-times"></i></button>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header">
                        <label class="label-filtro">Periodo</label>
                        <i class="fas fa-chevron-down icono-toggle"></i>
                    </div>
                    <div class="filtro-contenido">
                        <p class="descripcion-filtro">Seleccione un rango de fechas:</p>
                        <div class="rango-fechas">
                            <div><label class="label-pequeno">Desde:</label><input type="date" class="input-fecha"
                                    id="fechaDesde"></div>
                            <div><label class="label-pequeno">Hasta:</label><input type="date" class="input-fecha"
                                    id="fechaHasta"></div>
                        </div>
                    </div>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header">
                        <label class="label-filtro">Cadena</label>
                        <i class="fas fa-chevron-down icono-toggle"></i>
                    </div>
                    <div class="filtro-contenido">
                        <p class="descripcion-filtro">Seleccione la cadena:</p>
                        <select class="select-filtro" id="filtroCadena">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header">
                        <label class="label-filtro">Sucursal</label>
                        <i class="fas fa-chevron-down icono-toggle"></i>
                    </div>
                    <div class="filtro-contenido">
                        <p class="descripcion-filtro">Seleccione la sucursal:</p>
                        <select class="select-filtro" id="filtroSucursal">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div class="grupo-filtro">
                    <div class="filtro-header">
                        <label class="label-filtro">Repositor</label>
                        <i class="fas fa-chevron-down icono-toggle"></i>
                    </div>
                    <div class="filtro-contenido">
                        <p class="descripcion-filtro">Seleccione el repositor:</p>
                        <select class="select-filtro" id="filtroRepo">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
                <div class="botones-filtro" style="display:flex;gap:10px;">
                    <button id="btnAplicarFiltros" class="btn-aplicar-filtros">Aplicar</button>
                    <button id="btnLimpiarFiltros" class="btn-limpiar-filtros">Limpiar</button>
                </div>
            </aside>

            <div class="visita-nav">
                <button id="prevVisita" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                <div id="contenedorVisitas"></div>
                <button id="nextVisita" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </main>

    <footer class="footer-contacto">
        <p><i class="fa-solid fa-envelope"></i> contacto@gruposolvens.com | <i class="fa-solid fa-phone"></i> +54 11
            1234-5678</p>
    </footer>

    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close"><i class="fas fa-times"></i></button>
        <button class="lightbox-prev" id="lightbox-prev"><i class="fas fa-chevron-left"></i></button>
        <!-- visit metadata shown when lightbox is open -->
        <div id="lightbox-meta" class="lightbox-meta"></div>
        <img class="lightbox-img" id="lightbox-img" src="" alt="">
        <button class="lightbox-next" id="lightbox-next"><i class="fas fa-chevron-right"></i></button>
    </div>

    <script>
        const URL_BASE = '/api';

        let visitasData = [];
        let filteredVisitas = [];
        let visitaIndex = 0;
        let imgs = [];

        async function cargarVisitasCliente() {
            const idCliente = localStorage.getItem('id_usuario');
            const tipo = Number(localStorage.getItem('tipoUsuario'));
            if (tipo !== 2 || !idCliente) {
                window.location.href = 'login.html';
                return;
            }
            const res = await fetch(`${URL_BASE}/imagenes-aprobadas-cliente?id_cliente=${idCliente}`);
            if (!res.ok) {
                document.getElementById('contenedorVisitas').innerHTML = '<p>Error al obtener las im치genes.</p>';
                return;
            }
            visitasData = await res.json();
            if (visitasData.length === 0) {
                document.getElementById('contenedorVisitas').innerHTML = '<p>No hay im치genes aprobadas.</p>';
                return;
            }
            populateFilters();
            clearFilters();
        }

        function renderVisita(idx) {
            const v = filteredVisitas[idx];
            const cont = document.getElementById('contenedorVisitas');
            const imgsHtml = v.imagenes.map((img, i) => {
                return `
                <li>
                    <div${i === 0 ? ' class="scroll-start"' : ''}>
                        <div class="img">
                            <img src="../IMG/${img.ruta}" alt="Foto ${i + 1}">
                        </div>
                    </div>
                </li>`;
            }).join('');
            cont.innerHTML = `
        <div class="visita-bloque" data-id="${v.id}">
            <ul class="carousel">${imgsHtml}</ul>
            <div class="visita-meta">
                <span><i class="fas fa-store"></i>${v.cadena} / ${v.localidad} / ${v.sucursal}</span>
                <span><i class="fas fa-calendar-alt"></i>${new Date(v.fecha).toLocaleDateString('es-AR')}</span>
                <span><i class="fas fa-user"></i>${v.repositor}</span>
            </div>
        </div>`;
            wireImages();
            const showNav = filteredVisitas.length > 1;
            document.getElementById('prevVisita').style.display = showNav ? 'inline-block' : 'none';
            document.getElementById('nextVisita').style.display = showNav ? 'inline-block' : 'none';
        }

        function populateFilters() {
            const makeOptions = (items) => {
                const uniq = [...new Set(items)];
                return uniq.map(x => `<option value="${x}">${x}</option>`).join('');
            };
            const llenar = (id, opciones, titulo) => {
                const sel = document.getElementById(id);
                sel.innerHTML = `<option value="">${titulo}</option>` + opciones;
            };
            llenar('filtroCadena', makeOptions(visitasData.map(v => v.cadena)), 'Cadena (todas)');
            llenar('filtroSucursal', makeOptions(visitasData.map(v => v.sucursal)), 'Sucursal (todas)');
            llenar('filtroRepo', makeOptions(visitasData.map(v => v.repositor)), 'Repositor (todos)');
        }
        function applyFilters() {
            const fDesde = document.getElementById('fechaDesde').value;
            const fHasta = document.getElementById('fechaHasta').value;
            const fCad = document.getElementById('filtroCadena').value;
            const fSuc = document.getElementById('filtroSucursal').value;
            const fR = document.getElementById('filtroRepo').value;
            filteredVisitas = visitasData.filter(v => {
                if (fDesde) {
                    const vDate = new Date(v.fecha).setHours(0, 0, 0, 0);
                    const dDesde = new Date(fDesde).setHours(0, 0, 0, 0);
                    if (vDate < dDesde) return false;
                }
                if (fHasta) {
                    const vDate = new Date(v.fecha).setHours(0, 0, 0, 0);
                    const dHasta = new Date(fHasta).setHours(0, 0, 0, 0);
                    if (vDate > dHasta) return false;
                }
                if (fCad && v.cadena !== fCad) return false;
                if (fSuc && v.sucursal !== fSuc) return false;
                if (fR && v.repositor !== fR) return false;
                return true;
            });
            visitaIndex = 0;
            if (filteredVisitas.length === 0) {
                document.getElementById('contenedorVisitas').innerHTML = '<p>No hay visitas que coincidan.</p>';
                document.getElementById('prevVisita').style.display = 'none';
                document.getElementById('nextVisita').style.display = 'none';
                return;
            }
            renderVisita(visitaIndex);
        }
        function clearFilters() {
            ['fechaDesde', 'fechaHasta', 'filtroCadena', 'filtroSucursal', 'filtroRepo']
                .forEach(id => document.getElementById(id).value = '');
            applyFilters();
        }

        function wireImages() {
            imgs = Array.from(document.querySelectorAll('.carousel .img img'));
            imgs.forEach((img, i) => {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => openLightbox(i));
            });
        }

        // lightbox helpers
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        let currentImg = 0;
        function openLightbox(index) {
            currentImg = index;
            lbImg.src = imgs[currentImg].src;
            updateLightboxInfo();
            lightbox.classList.add('activo');
        }

        function updateLightboxInfo() {
            const v = filteredVisitas[visitaIndex];
            const metaEl = document.getElementById('lightbox-meta');
            if (v && metaEl) {
                metaEl.innerHTML = `
            <span><i class="fas fa-store"></i> <strong>${v.cadena}</strong> - ${v.sucursal} (${v.localidad})</span>
            <span><i class="fas fa-user"></i> ${v.repositor}</span>
            <span><i class="fas fa-calendar-alt"></i> ${new Date(v.fecha).toLocaleDateString('es-AR')}</span>
        `;
            }
        }
        function closeLightbox() {
            const lb = document.getElementById('lightbox');
            if (lb) lb.classList.remove('activo');
        }
        document.getElementById('lightbox-close').onclick = (e) => {
            e.stopPropagation();
            closeLightbox();
        };
        document.getElementById('lightbox-prev').addEventListener('click', () => {
            if (currentImg > 0) {
                currentImg--;
                lbImg.src = imgs[currentImg].src;
                updateLightboxInfo();
            } else {
                // Salto a visita anterior
                visitaIndex = (visitaIndex - 1 + filteredVisitas.length) % filteredVisitas.length;
                renderVisita(visitaIndex);
                openLightbox(imgs.length - 1);
            }
        });
        document.getElementById('lightbox-next').addEventListener('click', () => {
            if (currentImg < imgs.length - 1) {
                currentImg++;
                lbImg.src = imgs[currentImg].src;
                updateLightboxInfo();
            } else {
                // Salto a siguiente visita
                visitaIndex = (visitaIndex + 1) % filteredVisitas.length;
                renderVisita(visitaIndex);
                openLightbox(0);
            }
        });
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('activo')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') document.getElementById('lightbox-prev').click();
            if (e.key === 'ArrowRight') document.getElementById('lightbox-next').click();
        });

        document.getElementById('btnAplicarFiltros').addEventListener('click', applyFilters);
        document.getElementById('btnLimpiarFiltros').addEventListener('click', clearFilters);
        document.getElementById('prevVisita').addEventListener('click', () => {
            visitaIndex = (visitaIndex - 1 + filteredVisitas.length) % filteredVisitas.length;
            renderVisita(visitaIndex);
        });
        document.getElementById('nextVisita').addEventListener('click', () => {
            visitaIndex = (visitaIndex + 1) % filteredVisitas.length;
            renderVisita(visitaIndex);
        });

        document.addEventListener('DOMContentLoaded', cargarVisitasCliente);
    </script>
    <!-- filtros utility -->
    <script src="js/filtros.js"></script>

</body>

</html>